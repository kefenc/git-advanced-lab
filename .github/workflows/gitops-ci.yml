name: üõ°Ô∏è Python CI (GitOps + Argo CD)

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  packages: write

jobs:
  build-and-gitops:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: python-app
      IMAGE_TAG: ${{ github.sha }}
      REGISTRY: ghcr.io/${{ github.repository_owner }}

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Docker login (GHCR)
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .

      # 4Ô∏è‚É£ Trivy Image Scan (DevSecOps)
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
          severity: HIGH,CRITICAL
          exit-code: 0   # demo-friendly

      # 5Ô∏è‚É£ Push Docker image
      - name: Push Docker image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      # 6Ô∏è‚É£ Update Helm values.yaml
      - name: Update Helm image tag
        run: |
          sed -i "s/tag:.*/tag: \"$IMAGE_TAG\"/" helm/python-app/values.yaml

      # 7Ô∏è‚É£ Commit Helm change (GitOps trigger)
      - name: Commit Helm values
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add helm/python-app/values.yaml
          git commit -m "chore(gitops): update python-app image to $IMAGE_TAG" || echo "No changes"
          git push
